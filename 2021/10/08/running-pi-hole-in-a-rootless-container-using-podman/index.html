<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Running Pi-hole in a rootless container using podman | Viktor's blog</title>
<meta name=keywords content="podman,containers,systemd">
<meta name=description content="Introduction Pi-hole is a network-wide advertisement and tracker blocker. It&rsquo;s a DNS sinkhole for your home network. I&rsquo;ve been running it for several years now on my Raspberry Pi 3. Recently my SD card died and I didn&rsquo;t have a replacement at hand. So I decided to move Pi-hole to my fanless Intel NUC that I already use to host several services in my home network.
Here&rsquo;s my log of configuring it with all the problems that I encountered along the way.">
<meta name=author content="Viktor Ashirov">
<link rel=canonical href=https://vashirov.blog/2021/10/08/running-pi-hole-in-a-rootless-container-using-podman/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style>
<link rel=icon href=https://vashirov.blog/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://vashirov.blog/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://vashirov.blog/favicon-32x32.png>
<link rel=apple-touch-icon href=https://vashirov.blog/apple-touch-icon.png>
<link rel=mask-icon href=https://vashirov.blog/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Running Pi-hole in a rootless container using podman">
<meta property="og:description" content="Introduction Pi-hole is a network-wide advertisement and tracker blocker. It&rsquo;s a DNS sinkhole for your home network. I&rsquo;ve been running it for several years now on my Raspberry Pi 3. Recently my SD card died and I didn&rsquo;t have a replacement at hand. So I decided to move Pi-hole to my fanless Intel NUC that I already use to host several services in my home network.
Here&rsquo;s my log of configuring it with all the problems that I encountered along the way.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://vashirov.blog/2021/10/08/running-pi-hole-in-a-rootless-container-using-podman/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-08T11:07:01+02:00">
<meta property="article:modified_time" content="2021-10-08T11:07:01+02:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Running Pi-hole in a rootless container using podman">
<meta name=twitter:description content="Introduction Pi-hole is a network-wide advertisement and tracker blocker. It&rsquo;s a DNS sinkhole for your home network. I&rsquo;ve been running it for several years now on my Raspberry Pi 3. Recently my SD card died and I didn&rsquo;t have a replacement at hand. So I decided to move Pi-hole to my fanless Intel NUC that I already use to host several services in my home network.
Here&rsquo;s my log of configuring it with all the problems that I encountered along the way.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://vashirov.blog/posts/"},{"@type":"ListItem","position":2,"name":"Running Pi-hole in a rootless container using podman","item":"https://vashirov.blog/2021/10/08/running-pi-hole-in-a-rootless-container-using-podman/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Running Pi-hole in a rootless container using podman","name":"Running Pi-hole in a rootless container using podman","description":"Introduction Pi-hole is a network-wide advertisement and tracker blocker. It\u0026rsquo;s a DNS sinkhole for your home network. I\u0026rsquo;ve been running it for several years now on my Raspberry Pi 3. Recently my SD card died and I didn\u0026rsquo;t have a replacement at hand. So I decided to move Pi-hole to my fanless Intel NUC that I already use to host several services in my home network.\nHere\u0026rsquo;s my log of configuring it with all the problems that I encountered along the way.","keywords":["podman","containers","systemd"],"articleBody":"Introduction Pi-hole is a network-wide advertisement and tracker blocker. It’s a DNS sinkhole for your home network. I’ve been running it for several years now on my Raspberry Pi 3. Recently my SD card died and I didn’t have a replacement at hand. So I decided to move Pi-hole to my fanless Intel NUC that I already use to host several services in my home network.\nHere’s my log of configuring it with all the problems that I encountered along the way. I decided to first configure it on a freshly installed Fedora 34 VM to iron out all the issues that I may encounter.\nPi-hole has their own container image at https://hub.docker.com/r/pihole/pihole with a quick start guide that uses docker-compose. I don’t want to use docker-compose or podman-compose to manage this service. Instead I want to use systemd service to manage pihole container. Compose yaml file looks simple enough to replicate it using podman and systemd.\nPrerequisites Looking at the the prerequisites, we need to expose several ports: 53 TCP/UDP (DNS), 67 IPv4 UDP (DHCP), 547 IPv6 UDP (DHCPv6), 80 TCP (HTTP). I don’t want to use this Pi-hole instance to manage my DHCP as I already have it running on my home router, so that leaves only ports 53 and 80.\nPorts First I checked if there is something already running on port 53:\n$ sudo ss -ntpl src :53 State Recv-Q Send-Q Local Address:Port Peer Address:PortProcess LISTEN 0 4096 127.0.0.53%lo:53 0.0.0.0:* users:((\"systemd-resolve\",pid=1239,fd=18)) On Fedora since version 33 systemd-resolved is enabled by default and runs a local stub resolver on port 53. To disable it we need to create a drop-in config file /etc/systemd/resolved.conf.d/stub-listener.conf and add the following:\n[Resolve] DNSStubListener=no And restart systemd-resolved:\n$ sudo systemctl restart systemd-resolved Verify that nothing is running on port 53:\n$ sudo ss -ntpl src :53 State Recv-Q Send-Q Local Address:Port Peer Address:PortProcess Same for the port 80. As I didn’t have any web servers configured, the output was also empty.\nVolumes Pi-hole uses 2 volumes to store its configuration data: /etc/pihole and /etc/dnsmasq.d. Let’s create them first:\n$ podman volume create etc-pihole etc-pihole $ podman volume create etc-dnsmasq.d etc-dnsmasq.d Environment Timezone We need to provide timezone for the container using TZ environment variable. Current timezone on the host can be shown by running timedatectl:\n$ timedatectl show -p Timezone | awk -F= '{print $2}' Web UI password Password for the web UI is set using WEBPASSWD environment variable. If it’s not set, the password will be randomly generated.\nDNS According to the documentation, the default upstream DNS provider for Pi-hole is Google. If you want to change it, you can pass DNS1 and DNS2 variables with IP addresses. For example, to use CloudFlare DNS we need to pass these\nDNS1=1.1.1.1 DNS2=1.0.0.1 Podman Now that we have all the required information, we can run the container and see if it works:\n$ podman run --rm -ti \\ -p 53:53/tcp -p 53:53/udp \\ -p 80:80/tcp \\ -e DNS1=1.1.1.1 \\ -e DNS2=1.0.0.1 \\ -e TZ=$(timedatectl show -p Timezone | awk -F= '{print $2}') \\ -e WEBPASSWORD=my_super_secret_password \\ --name pihole docker.io/pihole/pihole:latest It failed for me with an error:\nError: rootlessport cannot expose privileged port 53, you can add 'net.ipv4.ip_unprivileged_port_start=53' to /etc/sysctl.conf (currently 1024), or choose a larger port number (= 1024): listen tcp 0.0.0.0:53: bind: permission denied It’s a known issue with rootless podman:\n Podman can not create containers that bind to ports The kernel does not allow processes without CAP_NET_BIND_SERVICE to bind to low ports. You can modify the net.ipv4.ip_unprivileged_port_start sysctl to change the lowest port. For example sysctl net.ipv4.ip_unprivileged_port_start=443 allows rootless Podman containers to bind to ports = 443.   So let’s fix this by doing what the error suggests and update the global sysctl configuration by adding net.ipv4.ip_unprivileged_port_start=53 to /etc/sysctl.d/99-sysctl.conf and running\n$ sudo sysctl -p net.ipv4.ip_unprivileged_port_start = 53 Let’s run podman command again, this time it succeeds:\ns6-init] making user provided files available at /var/run/s6/etc...exited 0. [s6-init] ensuring user provided files have correct perms...exited 0. [fix-attrs.d] applying ownership \u0026 permissions fixes... [fix-attrs.d] 01-resolver-resolv: applying... [fix-attrs.d] 01-resolver-resolv: exited 0. [fix-attrs.d] done. [cont-init.d] executing container initialization scripts... [cont-init.d] 20-start.sh: executing... ::: Starting docker specific checks \u0026 setup for docker pihole/pihole [i] Installing configs from /etc/.pihole... [i] Existing dnsmasq.conf found... it is not a Pi-hole file, leaving alone! [✓] Installed /etc/dnsmasq.d/01-pihole.conf [✓] Installed /etc/dnsmasq.d/06-rfc6761.conf Converting DNS1 to PIHOLE_DNS_ Converting DNS2 to PIHOLE_DNS_ Setting DNS servers based on PIHOLE_DNS_ variable [✓] New password set DNSMasq binding to default interface: eth0 Added ENV to php: \"PHP_ERROR_LOG\" = \"/var/log/lighttpd/error.log\", \"ServerIP\" = \"0.0.0.0\", \"CORS_HOSTS\" = \"\", \"VIRTUAL_HOST\" = \"0.0.0.0\", Using IPv4 and IPv6 ::: setup_blocklists now setting default blocklists up: ::: TIP: Use a docker volume for /etc/pihole/adlists.list if you want to customize for first boot ::: Blocklists (/etc/pihole/adlists.list) now set to: https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts ::: Testing pihole-FTL DNS: FTL started! ::: Testing lighttpd config: Syntax OK ::: All config checks passed, cleared for startup ... ::: Enabling Query Logging [i] Enabling logging... [✓] Restarting DNS server [✓] Logging has been enabled! ::: Docker start setup complete Checking if custom gravity.db is set in /etc/pihole/pihole-FTL.conf Pi-hole version is v5.5 (Latest: v5.5) AdminLTE version is v5.7 (Latest: v5.7) FTL version is v5.10.2 (Latest: v5.10.2) Container tag is: 2021.10 [cont-init.d] 20-start.sh: exited 0. [cont-init.d] done. [services.d] starting services Starting crond Starting pihole-FTL (no-daemon) as root Starting lighttpd Stopping pihole-FTL [services.d] done. Starting pihole-FTL (no-daemon) as root Stopping pihole-FTL Starting pihole-FTL (no-daemon) as root Troubleshooting Let’s see if DNS resolution works:\nOn the host I see that some process is listening on port 53\n$ ss -ntpul src :53 Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port Process udp UNCONN 0 0 *:53 *:* users:((\"exe\",pid=8035,fd=15)) tcp LISTEN 0 4096 *:53 *:* users:((\"exe\",pid=8035,fd=13)) nslookup doesn’t work:\n$ nslookup example.com 127.0.0.1 ;; connection timed out; no servers could be reached But dig works:\ndig +short A example.com 127.0.0.1 93.184.216.34 I’ve spent some time playing with tcpdump, but couldn’t figure out why this is happening.\nAlthough I noticed one interesting line in the logs from the Pi-hole container:\n DNSMasq binding to default interface: eth0\n It’s weird because I don’t have this interface inside my container:\n$ podman exec -til /bin/bash root@ddb049b6e786:/# ip a 1: lo:  mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever 2: tap0:  mtu 65520 qdisc fq_codel state UNKNOWN group default qlen 1000 link/ether 7a:04:e0:7c:82:3b brd ff:ff:ff:ff:ff:ff inet 10.0.2.100/24 brd 10.0.2.255 scope global tap0 valid_lft forever preferred_lft forever inet6 fe80::7804:e0ff:fe7c:823b/64 scope link valid_lft forever preferred_lft forever Pi-hole accepts INTERFACE environment variable to specify which interface to use. Let’s try again, this time using tap0 interface:\n$ podman run --rm -ti \\ -p 53:53/tcp -p 53:53/udp \\ -p 80:80/tcp \\ -e DNS1=1.1.1.1 \\ -e DNS2=1.0.0.1 \\ -e TZ=$(timedatectl show -p Timezone | awk -F= '{print $2}') \\ -e WEBPASSWORD=my_super_secret_password \\ -e INTERFACE=tap0 \\ --name pihole docker.io/pihole/pihole:latest [s6-init] making user provided files available at /var/run/s6/etc...exited 0. [s6-init] ensuring user provided files have correct perms...exited 0. [fix-attrs.d] applying ownership \u0026 permissions fixes... [fix-attrs.d] 01-resolver-resolv: applying... [fix-attrs.d] 01-resolver-resolv: exited 0. [fix-attrs.d] done. [cont-init.d] executing container initialization scripts... [cont-init.d] 20-start.sh: executing... ::: Starting docker specific checks \u0026 setup for docker pihole/pihole [i] Installing configs from /etc/.pihole... [i] Existing dnsmasq.conf found... it is not a Pi-hole file, leaving alone! [✓] Installed /etc/dnsmasq.d/01-pihole.conf [✓] Installed /etc/dnsmasq.d/06-rfc6761.conf Converting DNS1 to PIHOLE_DNS_ Converting DNS2 to PIHOLE_DNS_ Setting DNS servers based on PIHOLE_DNS_ variable [✓] New password set DNSMasq binding to custom interface: tap0 Added ENV to php: \"PHP_ERROR_LOG\" = \"/var/log/lighttpd/error.log\", \"ServerIP\" = \"0.0.0.0\", \"CORS_HOSTS\" = \"\", \"VIRTUAL_HOST\" = \"0.0.0.0\", Using IPv4 and IPv6 ::: setup_blocklists now setting default blocklists up: ::: TIP: Use a docker volume for /etc/pihole/adlists.list if you want to customize for first boot ::: Blocklists (/etc/pihole/adlists.list) now set to: https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts ::: Testing pihole-FTL DNS: FTL started! ::: Testing lighttpd config: Syntax OK ::: All config checks passed, cleared for startup ... ::: Enabling Query Logging [i] Enabling logging... [✓] Restarting DNS server [✓] Logging has been enabled! ::: Docker start setup complete Checking if custom gravity.db is set in /etc/pihole/pihole-FTL.conf Pi-hole version is v5.5 (Latest: v5.5) AdminLTE version is v5.7 (Latest: v5.7) FTL version is v5.10.2 (Latest: v5.10.2) Container tag is: 2021.10 [cont-init.d] 20-start.sh: exited 0. [cont-init.d] done. [services.d] starting services Starting crond Starting pihole-FTL (no-daemon) as root Starting lighttpd Stopping pihole-FTL [services.d] done. Starting pihole-FTL (no-daemon) as root Stopping pihole-FTL Starting pihole-FTL (no-daemon) as root This time interface binds to a correct interface:\n DNSMasq binding to custom interface: tap0\n Let’s try nslookup one more time:\n$ nslookup example.com 127.0.0.1 Server: 127.0.0.1 Address: 127.0.0.1#53 Non-authoritative answer: Name: example.com Address: 93.184.216.34 Name: example.com Address: 2606:2800:220:1:248:1893:25c8:1946 It works!\nRunning container as a systemd service Podman has a nice integration with systemd: it can generate a unit file for a container or a pod.\nFirst, we need to create a container. We will reuse the command we used to run podman, but instead of run argument we’ll use create:\n$ podman create -ti \\ -p 53:53/tcp -p 53:53/udp \\ -p 80:80/tcp \\ -e DNS1=1.1.1.1 \\ -e DNS2=1.0.0.1 \\ -e TZ=$(timedatectl show -p Timezone | awk -F= '{print $2}') \\ -e WEBPASSWORD=my_super_secret_password \\ -e INTERFACE=tap0 \\ --name pihole docker.io/pihole/pihole:latest c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0 $ podman container ls -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c6648518e47a docker.io/pihole/pihole:latest 12 seconds ago Created 0.0.0.0:53-53/tcp, 0.0.0.0:53-53/udp, 0.0.0.0:80-80/tcp pihole $ podman generate systemd --name pihole # container-pihole.service # autogenerated by Podman 3.4.0 # Fri Oct 8 16:25:44 UTC 2021 [Unit] Description=Podman container-pihole.service Documentation=man:podman-generate-systemd(1) Wants=network-online.target After=network-online.target RequiresMountsFor=/run/user/1000/containers [Service] Environment=PODMAN_SYSTEMD_UNIT=%n Restart=on-failure TimeoutStopSec=70 ExecStart=/usr/bin/podman start pihole ExecStop=/usr/bin/podman stop -t 10 pihole ExecStopPost=/usr/bin/podman stop -t 10 pihole PIDFile=/run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/conmon.pid Type=forking [Install] WantedBy=multi-user.target default.target Save this under $HOME/.config/systemd/user/container-pihole.service and reload systemd:\n$ systemctl --user daemon-reload And start it via systemd:\n$ systemctl --user start container-pihole Let’s see if it indeed runs as an unpriviliged container:\n$ ps auxwwf ... fedora 720 0.0 1.5 23404 14948 ? Ss 10:37 0:00 /usr/lib/systemd/systemd --user fedora 722 0.0 0.5 51204 5164 ? S 10:37 0:00 \\_ (sd-pam) fedora 1059 0.0 0.3 18716 3808 ? Ss 11:17 0:00 \\_ /usr/bin/dbus-broker-launch --scope user fedora 1060 0.0 0.1 5044 1180 ? S 11:17 0:00 | \\_ dbus-broker --log 4 --controller 10 --machine-id 2b306968706342eabbbbb5330d2e7c70 --max-bytes 100000000000000 --max-fds 25000000000000 --max-matches 5000000000 fedora 10545 0.0 0.3 5108 3020 ? S 16:27 0:00 \\_ /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/cni-a629e2c5-fb83-4679-8b0f-3a4e57e03217 tap0 fedora 10547 0.0 4.8 1291228 47952 ? Sl 16:27 0:00 \\_ containers-rootlessport fedora 10553 0.0 4.8 1142100 47788 ? Sl 16:27 0:00 | \\_ containers-rootlessport-child fedora 10561 0.0 0.2 82796 2640 ? Ssl 16:27 0:00 \\_ /usr/bin/conmon --api-version 1 -c c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0 -u c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0 -r /usr/bin/crun -b /home/fedora/.local/share/containers/storage/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata -p /run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/pidfile -n pihole --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l k8s-file:/home/fedora/.local/share/containers/storage/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/ctr.log --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/oci-log -t --conmon-pidfile /run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /home/fedora/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0 fedora 10564 0.0 0.0 204 4 pts/0 Ss+ 16:27 0:00 \\_ s6-svscan -t0 /var/run/s6/services fedora 10591 0.0 0.0 204 4 pts/0 S+ 16:27 0:00 \\_ s6-supervise s6-fdholderd fedora 10971 0.0 0.0 204 4 pts/0 S+ 16:27 0:00 \\_ s6-supervise cron fedora 10976 0.0 0.2 3740 2860 ? Ss 16:27 0:00 | \\_ bash ./run fedora 10992 0.0 0.2 5516 2412 ? S 16:27 0:00 | \\_ /usr/sbin/cron -f fedora 10972 0.0 0.0 204 4 pts/0 S+ 16:27 0:00 \\_ s6-supervise lighttpd fedora 10978 0.0 0.2 3740 2768 ? Ss 16:27 0:00 | \\_ bash ./run 100032 10985 0.0 0.5 10240 5584 ? S 16:27 0:00 | \\_ lighttpd -D -f /etc/lighttpd/lighttpd.conf 100032 11027 0.0 2.1 197680 21264 ? Ss 16:27 0:00 | \\_ /usr/bin/php-cgi 100032 11028 0.0 0.4 197680 4224 ? S 16:27 0:00 | \\_ /usr/bin/php-cgi 100032 11029 0.0 0.4 197680 4224 ? S 16:27 0:00 | \\_ /usr/bin/php-cgi 100032 11030 0.0 0.4 197680 4224 ? S 16:27 0:00 | \\_ /usr/bin/php-cgi 100032 11031 0.0 0.4 197680 4224 ? S 16:27 0:00 | \\_ /usr/bin/php-cgi fedora 10973 0.0 0.0 204 4 pts/0 S+ 16:27 0:00 \\_ s6-supervise pihole-FTL fedora 11111 0.0 0.3 3740 2968 ? Ss 16:27 0:00 \\_ bash ./run fedora 11116 0.0 0.6 320556 6384 ? Sl 16:27 0:00 \\_ pihole-FTL no-daemon As you can see, none of the components from Pi-hole are running as root.\nConclusion By using podman I was able to run Pi-hole in a rootless unprivileged container as a user systemd service, that is fully controlled by systemd.\nI’ve updated DHCP configuration on my router to use newly created Pi-hole instance. I even noticed some speed improvements, especially when I run OpenShift cluster in my lab: OCP generates a lot of DNS traffic that would slow down my RPi. But with Pi-hole running on my Intel NUC I don’t see any delays.\n","wordCount":"2152","inLanguage":"en","datePublished":"2021-10-08T11:07:01+02:00","dateModified":"2021-10-08T11:07:01+02:00","author":{"@type":"Person","name":"Viktor Ashirov"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://vashirov.blog/2021/10/08/running-pi-hole-in-a-rootless-container-using-podman/"},"publisher":{"@type":"Organization","name":"Viktor's blog","logo":{"@type":"ImageObject","url":"https://vashirov.blog/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://vashirov.blog/ accesskey=h title="Viktor's blog (Alt + H)">Viktor's blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://vashirov.blog/archives/ title=Archives>
<span>Archives</span>
</a>
</li>
<li>
<a href=https://vashirov.blog/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://vashirov.blog/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://vashirov.blog/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://vashirov.blog/index.xml title=RSS>
<span>RSS</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Running Pi-hole in a rootless container using podman
</h1>
<div class=post-meta>October 8, 2021&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Viktor Ashirov
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#introduction aria-label=Introduction>Introduction</a><ul>
<li>
<a href=#prerequisites aria-label=Prerequisites>Prerequisites</a><ul>
<li>
<a href=#ports aria-label=Ports>Ports</a></li>
<li>
<a href=#volumes aria-label=Volumes>Volumes</a></li>
<li>
<a href=#environment aria-label=Environment>Environment</a><ul>
<li>
<a href=#timezone aria-label=Timezone>Timezone</a></li>
<li>
<a href=#web-ui-password aria-label="Web UI password">Web UI password</a></li>
<li>
<a href=#dns aria-label=DNS>DNS</a></li></ul>
</li></ul>
</li>
<li>
<a href=#podman aria-label=Podman>Podman</a><ul>
<li>
<a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a></li></ul>
</li>
<li>
<a href=#running-container-as-a-systemd-service aria-label="Running container as a systemd service">Running container as a systemd service</a></li></ul>
</li>
<li>
<a href=#conclusion aria-label=Conclusion>Conclusion</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1>
<p><a href=https://pi-hole.net/>Pi-hole</a> is a network-wide advertisement and tracker blocker. It&rsquo;s a DNS sinkhole for your home network.
I&rsquo;ve been running it for several years now on my Raspberry Pi 3. Recently my SD card died and I didn&rsquo;t have a replacement at hand. So I decided to move Pi-hole to my fanless Intel NUC that I already use to host several services in my home network.</p>
<p>Here&rsquo;s my log of configuring it with all the problems that I encountered along the way.
I decided to first configure it on a freshly installed Fedora 34 VM to iron out all the issues that I may encounter.</p>
<p>Pi-hole has their own container image at <a href=https://hub.docker.com/r/pihole/pihole>https://hub.docker.com/r/pihole/pihole</a> with a quick start guide that uses docker-compose. I don&rsquo;t want to use docker-compose or podman-compose to manage this service. Instead I want to use systemd service to manage pihole container. Compose yaml file looks simple enough to replicate it using podman and systemd.</p>
<h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2>
<p>Looking at the the <a href=https://docs.pi-hole.net/main/prerequisites/>prerequisites</a>, we need to expose several ports: 53 TCP/UDP (DNS), 67 IPv4 UDP (DHCP), 547 IPv6 UDP (DHCPv6), 80 TCP (HTTP). I don&rsquo;t want to use this Pi-hole instance to manage my DHCP as I already have it running on my home router, so that leaves only ports 53 and 80.</p>
<h3 id=ports>Ports<a hidden class=anchor aria-hidden=true href=#ports>#</a></h3>
<p>First I checked if there is something already running on port 53:</p>
<pre tabindex=0><code>$ sudo ss -ntpl src :53
State  Recv-Q Send-Q Local Address:Port Peer Address:PortProcess
LISTEN 0      4096   127.0.0.53%lo:53        0.0.0.0:*    users:((&quot;systemd-resolve&quot;,pid=1239,fd=18))
</code></pre><p>On Fedora since version 33 <code>systemd-resolved</code> is <a href=https://fedoraproject.org/wiki/Changes/systemd-resolved>enabled by default</a> and runs a local stub resolver on port 53.
To disable it we need to create a drop-in config file <code>/etc/systemd/resolved.conf.d/stub-listener.conf</code> and add the following:</p>
<pre tabindex=0><code>[Resolve]
DNSStubListener=no
</code></pre><p>And restart systemd-resolved:</p>
<pre tabindex=0><code>$ sudo systemctl restart systemd-resolved
</code></pre><p>Verify that nothing is running on port 53:</p>
<pre tabindex=0><code>$ sudo ss -ntpl src :53 
State Recv-Q Send-Q Local Address:Port Peer Address:PortProcess
</code></pre><p>Same for the port 80. As I didn&rsquo;t have any web servers configured, the output was also empty.</p>
<h3 id=volumes>Volumes<a hidden class=anchor aria-hidden=true href=#volumes>#</a></h3>
<p>Pi-hole uses 2 volumes to store its configuration data: <code>/etc/pihole</code> and <code>/etc/dnsmasq.d</code>. Let&rsquo;s create them first:</p>
<pre tabindex=0><code>$ podman volume create etc-pihole
etc-pihole
$ podman volume create etc-dnsmasq.d
etc-dnsmasq.d
</code></pre><h3 id=environment>Environment<a hidden class=anchor aria-hidden=true href=#environment>#</a></h3>
<h4 id=timezone>Timezone<a hidden class=anchor aria-hidden=true href=#timezone>#</a></h4>
<p>We need to provide timezone for the container using <code>TZ</code> environment variable. Current timezone on the host can be shown by running <code>timedatectl</code>:</p>
<pre tabindex=0><code>$ timedatectl show -p Timezone | awk -F= '{print $2}'
</code></pre><h4 id=web-ui-password>Web UI password<a hidden class=anchor aria-hidden=true href=#web-ui-password>#</a></h4>
<p>Password for the web UI is set using <code>WEBPASSWD</code> environment variable. If it&rsquo;s not set, the password will be randomly generated.</p>
<h4 id=dns>DNS<a hidden class=anchor aria-hidden=true href=#dns>#</a></h4>
<p>According to the <a href=https://docs.pi-hole.net/guides/dns/upstream-dns-providers/>documentation</a>, the default upstream DNS provider for Pi-hole is Google. If you want to change it, you can pass DNS1 and DNS2 variables with IP addresses. For example, to use CloudFlare DNS we need to pass these</p>
<pre tabindex=0><code>DNS1=1.1.1.1
DNS2=1.0.0.1
</code></pre><h2 id=podman>Podman<a hidden class=anchor aria-hidden=true href=#podman>#</a></h2>
<p>Now that we have all the required information, we can run the container and see if it works:</p>
<pre tabindex=0><code>$ podman run --rm -ti \
-p 53:53/tcp -p 53:53/udp \
-p 80:80/tcp \
-e DNS1=1.1.1.1 \
-e DNS2=1.0.0.1 \
-e TZ=$(timedatectl show -p Timezone | awk -F= '{print $2}') \
-e WEBPASSWORD=my_super_secret_password \
--name pihole docker.io/pihole/pihole:latest
</code></pre><p>It failed for me with an error:</p>
<pre tabindex=0><code>Error: rootlessport cannot expose privileged port 53, you can add 'net.ipv4.ip_unprivileged_port_start=53' to /etc/sysctl.conf (currently 1024), or choose a larger port number (&gt;= 1024): listen tcp 0.0.0.0:53: bind: permission denied
</code></pre><p>It&rsquo;s a <a href=https://github.com/containers/podman/blob/main/rootless.md>known issue</a> with rootless podman:</p>
<blockquote>
<p>Podman can not create containers that bind to ports &lt; 1024.</p>
<ul>
<li>The kernel does not allow processes without CAP_NET_BIND_SERVICE to bind to low ports.</li>
<li>You can modify the net.ipv4.ip_unprivileged_port_start sysctl to change the lowest port. For example sysctl net.ipv4.ip_unprivileged_port_start=443 allows rootless Podman containers to bind to ports >= 443.</li>
</ul>
</blockquote>
<p>So let&rsquo;s fix this by doing what the error suggests and update the global sysctl configuration by adding <code>net.ipv4.ip_unprivileged_port_start=53</code> to <code>/etc/sysctl.d/99-sysctl.conf</code> and running</p>
<pre tabindex=0><code>$ sudo sysctl -p 
net.ipv4.ip_unprivileged_port_start = 53
</code></pre><p>Let&rsquo;s run <code>podman</code> command again, this time it succeeds:</p>
<pre tabindex=0><code>s6-init] making user provided files available at /var/run/s6/etc...exited 0.
[s6-init] ensuring user provided files have correct perms...exited 0.
[fix-attrs.d] applying ownership &amp; permissions fixes...
[fix-attrs.d] 01-resolver-resolv: applying... 
[fix-attrs.d] 01-resolver-resolv: exited 0.
[fix-attrs.d] done.
[cont-init.d] executing container initialization scripts...
[cont-init.d] 20-start.sh: executing... 
 ::: Starting docker specific checks &amp; setup for docker pihole/pihole

  [i] Installing configs from /etc/.pihole...
  [i] Existing dnsmasq.conf found... it is not a Pi-hole file, leaving alone!
  [✓] Installed /etc/dnsmasq.d/01-pihole.conf
  [✓] Installed /etc/dnsmasq.d/06-rfc6761.conf
Converting DNS1 to PIHOLE_DNS_
Converting DNS2 to PIHOLE_DNS_
Setting DNS servers based on PIHOLE_DNS_ variable
  [✓] New password set
DNSMasq binding to default interface: eth0
Added ENV to php:
                        &quot;PHP_ERROR_LOG&quot; =&gt; &quot;/var/log/lighttpd/error.log&quot;,
                        &quot;ServerIP&quot; =&gt; &quot;0.0.0.0&quot;,
                        &quot;CORS_HOSTS&quot; =&gt; &quot;&quot;,
                        &quot;VIRTUAL_HOST&quot; =&gt; &quot;0.0.0.0&quot;,
Using IPv4 and IPv6
::: setup_blocklists now setting default blocklists up: 
::: TIP: Use a docker volume for /etc/pihole/adlists.list if you want to customize for first boot
::: Blocklists (/etc/pihole/adlists.list) now set to:
https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
::: Testing pihole-FTL DNS: FTL started!
::: Testing lighttpd config: Syntax OK
::: All config checks passed, cleared for startup ...
::: Enabling Query Logging
  [i] Enabling logging...
  [✓] Restarting DNS server
  [✓] Logging has been enabled!
 ::: Docker start setup complete
  Checking if custom gravity.db is set in /etc/pihole/pihole-FTL.conf
  Pi-hole version is v5.5 (Latest: v5.5)
  AdminLTE version is v5.7 (Latest: v5.7)
  FTL version is v5.10.2 (Latest: v5.10.2)
  Container tag is: 2021.10
[cont-init.d] 20-start.sh: exited 0.
[cont-init.d] done.
[services.d] starting services
Starting crond
Starting pihole-FTL (no-daemon) as root
Starting lighttpd
Stopping pihole-FTL
[services.d] done.
Starting pihole-FTL (no-daemon) as root
Stopping pihole-FTL
Starting pihole-FTL (no-daemon) as root
</code></pre><h3 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h3>
<p>Let&rsquo;s see if DNS resolution works:</p>
<p>On the host I see that some process is listening on port 53</p>
<pre tabindex=0><code>$ ss -ntpul src :53
Netid  State   Recv-Q  Send-Q   Local Address:Port   Peer Address:Port  Process                          
udp    UNCONN  0       0                    *:53                *:*      users:((&quot;exe&quot;,pid=8035,fd=15))  
tcp    LISTEN  0       4096                 *:53                *:*      users:((&quot;exe&quot;,pid=8035,fd=13))  
</code></pre><p><code>nslookup</code> doesn&rsquo;t work:</p>
<pre tabindex=0><code>$ nslookup example.com 127.0.0.1
;; connection timed out; no servers could be reached
</code></pre><p>But <code>dig</code> works:</p>
<pre tabindex=0><code>dig +short A example.com 127.0.0.1
93.184.216.34
</code></pre><p>I&rsquo;ve spent some time playing with <code>tcpdump</code>, but couldn&rsquo;t figure out why this is happening.</p>
<p>Although I noticed one interesting line in the logs from the Pi-hole container:</p>
<blockquote>
<p><code>DNSMasq binding to default interface: eth0</code></p>
</blockquote>
<p>It&rsquo;s weird because I don&rsquo;t have this interface inside my container:</p>
<pre tabindex=0><code>$ podman exec -til /bin/bash 
root@ddb049b6e786:/# ip a 
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: tap0: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 65520 qdisc fq_codel state UNKNOWN group default qlen 1000
    link/ether 7a:04:e0:7c:82:3b brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.100/24 brd 10.0.2.255 scope global tap0
       valid_lft forever preferred_lft forever
    inet6 fe80::7804:e0ff:fe7c:823b/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>Pi-hole accepts <code>INTERFACE</code> environment variable to specify which interface to use. Let&rsquo;s try again, this time using <code>tap0</code> interface:</p>
<pre tabindex=0><code>$ podman run --rm -ti \
-p 53:53/tcp -p 53:53/udp \
-p 80:80/tcp \
-e DNS1=1.1.1.1 \
-e DNS2=1.0.0.1 \
-e TZ=$(timedatectl show -p Timezone | awk -F= '{print $2}') \
-e WEBPASSWORD=my_super_secret_password \
-e INTERFACE=tap0 \
--name pihole docker.io/pihole/pihole:latest
</code></pre><pre tabindex=0><code>[s6-init] making user provided files available at /var/run/s6/etc...exited 0.
[s6-init] ensuring user provided files have correct perms...exited 0.
[fix-attrs.d] applying ownership &amp; permissions fixes...
[fix-attrs.d] 01-resolver-resolv: applying... 
[fix-attrs.d] 01-resolver-resolv: exited 0.
[fix-attrs.d] done.
[cont-init.d] executing container initialization scripts...
[cont-init.d] 20-start.sh: executing... 
 ::: Starting docker specific checks &amp; setup for docker pihole/pihole

  [i] Installing configs from /etc/.pihole...
  [i] Existing dnsmasq.conf found... it is not a Pi-hole file, leaving alone!
  [✓] Installed /etc/dnsmasq.d/01-pihole.conf
  [✓] Installed /etc/dnsmasq.d/06-rfc6761.conf
Converting DNS1 to PIHOLE_DNS_
Converting DNS2 to PIHOLE_DNS_
Setting DNS servers based on PIHOLE_DNS_ variable
  [✓] New password set
DNSMasq binding to custom interface: tap0
Added ENV to php:
                        &quot;PHP_ERROR_LOG&quot; =&gt; &quot;/var/log/lighttpd/error.log&quot;,
                        &quot;ServerIP&quot; =&gt; &quot;0.0.0.0&quot;,
                        &quot;CORS_HOSTS&quot; =&gt; &quot;&quot;,
                        &quot;VIRTUAL_HOST&quot; =&gt; &quot;0.0.0.0&quot;,
Using IPv4 and IPv6
::: setup_blocklists now setting default blocklists up: 
::: TIP: Use a docker volume for /etc/pihole/adlists.list if you want to customize for first boot
::: Blocklists (/etc/pihole/adlists.list) now set to:
https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
::: Testing pihole-FTL DNS: FTL started!
::: Testing lighttpd config: Syntax OK
::: All config checks passed, cleared for startup ...
::: Enabling Query Logging
  [i] Enabling logging...
  [✓] Restarting DNS server
  [✓] Logging has been enabled!
 ::: Docker start setup complete
  Checking if custom gravity.db is set in /etc/pihole/pihole-FTL.conf
  Pi-hole version is v5.5 (Latest: v5.5)
  AdminLTE version is v5.7 (Latest: v5.7)
  FTL version is v5.10.2 (Latest: v5.10.2)
  Container tag is: 2021.10
[cont-init.d] 20-start.sh: exited 0.
[cont-init.d] done.
[services.d] starting services
Starting crond
Starting pihole-FTL (no-daemon) as root
Starting lighttpd
Stopping pihole-FTL
[services.d] done.
Starting pihole-FTL (no-daemon) as root
Stopping pihole-FTL
Starting pihole-FTL (no-daemon) as root

</code></pre><p>This time interface binds to a correct interface:</p>
<blockquote>
<p><code>DNSMasq binding to custom interface: tap0</code></p>
</blockquote>
<p>Let&rsquo;s try <code>nslookup</code> one more time:</p>
<pre tabindex=0><code>$ nslookup example.com 127.0.0.1
Server:         127.0.0.1
Address:        127.0.0.1#53

Non-authoritative answer:
Name:   example.com
Address: 93.184.216.34
Name:   example.com
Address: 2606:2800:220:1:248:1893:25c8:1946

</code></pre><p>It works!</p>
<h2 id=running-container-as-a-systemd-service>Running container as a systemd service<a hidden class=anchor aria-hidden=true href=#running-container-as-a-systemd-service>#</a></h2>
<p>Podman has a nice integration with systemd: it can <a href=https://docs.podman.io/en/latest/markdown/podman-generate-systemd.1.html>generate</a> a unit file for a container or a pod.</p>
<p>First, we need to create a container. We will reuse the command we used to run podman, but instead of <code>run</code> argument we&rsquo;ll use <code>create</code>:</p>
<pre tabindex=0><code>$ podman create -ti \
-p 53:53/tcp -p 53:53/udp \
-p 80:80/tcp \
-e DNS1=1.1.1.1 \
-e DNS2=1.0.0.1 \
-e TZ=$(timedatectl show -p Timezone | awk -F= '{print $2}') \
-e WEBPASSWORD=my_super_secret_password \
-e INTERFACE=tap0 \
--name pihole docker.io/pihole/pihole:latest
c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0
</code></pre><pre tabindex=0><code>$ podman container ls -a
CONTAINER ID  IMAGE                           COMMAND     CREATED        STATUS      PORTS                                                       NAMES
c6648518e47a  docker.io/pihole/pihole:latest              12 seconds ago  Created     0.0.0.0:53-&gt;53/tcp, 0.0.0.0:53-&gt;53/udp, 0.0.0.0:80-&gt;80/tcp  pihole
</code></pre><pre tabindex=0><code>$ podman generate systemd --name pihole
# container-pihole.service
# autogenerated by Podman 3.4.0
# Fri Oct  8 16:25:44 UTC 2021

[Unit]
Description=Podman container-pihole.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start pihole
ExecStop=/usr/bin/podman stop -t 10 pihole
ExecStopPost=/usr/bin/podman stop -t 10 pihole
PIDFile=/run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target
</code></pre><p>Save this under <code>$HOME/.config/systemd/user/container-pihole.service</code> and reload systemd:</p>
<pre tabindex=0><code>$ systemctl --user daemon-reload
</code></pre><p>And start it via systemd:</p>
<pre tabindex=0><code>$ systemctl --user start container-pihole 
</code></pre><p>Let&rsquo;s see if it indeed runs as an unpriviliged container:</p>
<pre tabindex=0><code>$ ps auxwwf
...
fedora       720  0.0  1.5  23404 14948 ?        Ss   10:37   0:00 /usr/lib/systemd/systemd --user
fedora       722  0.0  0.5  51204  5164 ?        S    10:37   0:00  \_ (sd-pam)
fedora      1059  0.0  0.3  18716  3808 ?        Ss   11:17   0:00  \_ /usr/bin/dbus-broker-launch --scope user
fedora      1060  0.0  0.1   5044  1180 ?        S    11:17   0:00  |   \_ dbus-broker --log 4 --controller 10 --machine-id 2b306968706342eabbbbb5330d2e7c70 --max-bytes 100000000000000 --max-fds 25000000000000 --max-matches 5000000000
fedora     10545  0.0  0.3   5108  3020 ?        S    16:27   0:00  \_ /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/cni-a629e2c5-fb83-4679-8b0f-3a4e57e03217 tap0
fedora     10547  0.0  4.8 1291228 47952 ?       Sl   16:27   0:00  \_ containers-rootlessport
fedora     10553  0.0  4.8 1142100 47788 ?       Sl   16:27   0:00  |   \_ containers-rootlessport-child
fedora     10561  0.0  0.2  82796  2640 ?        Ssl  16:27   0:00  \_ /usr/bin/conmon --api-version 1 -c c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0 -u c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0 -r /usr/bin/crun -b /home/fedora/.local/share/containers/storage/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata -p /run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/pidfile -n pihole --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l k8s-file:/home/fedora/.local/share/containers/storage/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/ctr.log --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/oci-log -t --conmon-pidfile /run/user/1000/containers/overlay-containers/c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /home/fedora/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg c6648518e47aff6b8a8c712fd2abc0a9dc5a426eeb071d76bee595263ba2dff0
fedora     10564  0.0  0.0    204     4 pts/0    Ss+  16:27   0:00      \_ s6-svscan -t0 /var/run/s6/services
fedora     10591  0.0  0.0    204     4 pts/0    S+   16:27   0:00          \_ s6-supervise s6-fdholderd
fedora     10971  0.0  0.0    204     4 pts/0    S+   16:27   0:00          \_ s6-supervise cron
fedora     10976  0.0  0.2   3740  2860 ?        Ss   16:27   0:00          |   \_ bash ./run
fedora     10992  0.0  0.2   5516  2412 ?        S    16:27   0:00          |       \_ /usr/sbin/cron -f
fedora     10972  0.0  0.0    204     4 pts/0    S+   16:27   0:00          \_ s6-supervise lighttpd
fedora     10978  0.0  0.2   3740  2768 ?        Ss   16:27   0:00          |   \_ bash ./run
100032     10985  0.0  0.5  10240  5584 ?        S    16:27   0:00          |       \_ lighttpd -D -f /etc/lighttpd/lighttpd.conf
100032     11027  0.0  2.1 197680 21264 ?        Ss   16:27   0:00          |           \_ /usr/bin/php-cgi
100032     11028  0.0  0.4 197680  4224 ?        S    16:27   0:00          |               \_ /usr/bin/php-cgi
100032     11029  0.0  0.4 197680  4224 ?        S    16:27   0:00          |               \_ /usr/bin/php-cgi
100032     11030  0.0  0.4 197680  4224 ?        S    16:27   0:00          |               \_ /usr/bin/php-cgi
100032     11031  0.0  0.4 197680  4224 ?        S    16:27   0:00          |               \_ /usr/bin/php-cgi
fedora     10973  0.0  0.0    204     4 pts/0    S+   16:27   0:00          \_ s6-supervise pihole-FTL
fedora     11111  0.0  0.3   3740  2968 ?        Ss   16:27   0:00              \_ bash ./run
fedora     11116  0.0  0.6 320556  6384 ?        Sl   16:27   0:00                  \_ pihole-FTL no-daemon
</code></pre><p>As you can see, none of the components from Pi-hole are running as root.</p>
<h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1>
<p>By using <code>podman</code> I was able to run Pi-hole in a rootless unprivileged container as a user systemd service, that is fully controlled by systemd.</p>
<p>I&rsquo;ve updated DHCP configuration on my router to use newly created Pi-hole instance. I even noticed some speed improvements, especially when I run OpenShift cluster in my lab: OCP generates a lot of DNS traffic that would slow down my RPi. But with Pi-hole running on my Intel NUC I don&rsquo;t see any delays.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://vashirov.blog/tags/podman/>podman</a></li>
<li><a href=https://vashirov.blog/tags/containers/>containers</a></li>
<li><a href=https://vashirov.blog/tags/systemd/>systemd</a></li>
</ul>
</footer><script>document.write('<script src="https://utteranc.es/client.js" repo="vashirov/vashirov.github.io" issue-term="pathname" label="comment" '),document.body.className.includes("dark")?document.write('theme="github-dark"'):document.write('theme="github-light"'),document.write(' crossorigin="anonymous" async><\/script>')</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){const a=document.querySelector('iframe').contentWindow;a.postMessage({type:'set-theme',theme:'github-light'},'https://utteranc.es')}else{const a=document.querySelector('iframe').contentWindow;a.postMessage({type:'set-theme',theme:'github-dark'},'https://utteranc.es')}})</script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://vashirov.blog/>Viktor's blog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>